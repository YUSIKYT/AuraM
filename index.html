<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>auraM | Final Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #020202; color: #ffffff; font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; touch-action: pan-x pan-y; }
        .syncopate { font-family: 'Syncopate', sans-serif; }
        .glass-panel { background: #0a0a0a; backdrop-filter: blur(40px); border-right: 1px solid rgba(255, 255, 255, 0.05); }
        .aura-card { background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.06); }
        input { font-size: 16px !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 10px; }
        .msg-out { background: #6366f1; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2); }
        .fade-up { animation: fadeUp 0.4s ease-out forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, query, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        window.FB = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, query, getDocs };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [db, setDb] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [configError, setConfigError] = useState(false);
            
            // Основные состояния интерфейса
            const [authMode, setAuthMode] = useState('login');
            const [form, setForm] = useState({ username: '', password: '', name: '' });
            const [chats, setChats] = useState([]);
            const [activeChat, setActiveChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            const [settingsOpen, setSettingsOpen] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                const init = async () => {
                    try {
                        // Исправление для GitHub: если переменной нет, берем пустой объект или выводим ошибку
                        const cfgStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                        if (!cfgStr) {
                            setConfigError(true);
                            setLoading(false);
                            return;
                        }

                        const config = JSON.parse(cfgStr);
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'auram-app';
                        window.currentAppId = appId;

                        const app = window.FB.initializeApp(config);
                        const auth = window.FB.getAuth(app);
                        const _db = window.FB.getFirestore(app);
                        setDb(_db);

                        await window.FB.signInAnonymously(auth);
                        window.FB.onAuthStateChanged(auth, (u) => {
                            const activeId = localStorage.getItem('auram_active_id');
                            if (activeId) fetchProfile(activeId, _db);
                            setLoading(false);
                        });
                    } catch (e) {
                        console.error(e);
                        setConfigError(true);
                        setLoading(false);
                    }
                };
                init();
            }, []);

            const fetchProfile = async (id, _db) => {
                const snap = await window.FB.getDoc(window.FB.doc(_db, 'artifacts', window.currentAppId, 'public', 'data', 'users', id));
                if (snap.exists()) setProfile(snap.data());
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                const id = form.username.toLowerCase().trim();
                const userRef = window.FB.doc(db, 'artifacts', window.currentAppId, 'public', 'data', 'users', id);
                
                if (authMode === 'register') {
                    const acc = { id, name: form.name, password: form.password, avatar: `https://ui-avatars.com/api/?name=${form.name}&background=6366f1&color=fff` };
                    await window.FB.setDoc(userRef, acc);
                    setProfile(acc);
                } else {
                    const snap = await window.FB.getDoc(userRef);
                    if (snap.exists() && snap.data().password === form.password) setProfile(snap.data());
                }
                localStorage.setItem('auram_active_id', id);
            };

            useEffect(() => {
                if (!db || !profile) return;
                return window.FB.onSnapshot(window.FB.collection(db, 'artifacts', window.currentAppId, 'public', 'data', 'chats'), (snap) => {
                    setChats(snap.docs.map(d => ({id: d.id, ...d.data()})).filter(c => c.isPublic || c.members?.includes(profile.id)));
                });
            }, [db, profile]);

            useEffect(() => {
                if (!db || !activeChat) return;
                const q = window.FB.collection(db, 'artifacts', window.currentAppId, 'public', 'data', 'messages');
                return window.FB.onSnapshot(q, (snap) => {
                    setMessages(snap.docs.map(d => ({id: d.id, ...d.data()})).filter(m => m.chatId === activeChat.id).sort((a,b) => a.timestamp - b.timestamp));
                });
            }, [db, activeChat]);

            useEffect(() => { 
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
                if (window.lucide) window.lucide.createIcons();
            });

            if (configError) return (
                <div className="h-screen flex items-center justify-center bg-black p-10 text-center">
                    <div className="max-w-md">
                        <h1 className="text-red-500 text-2xl font-bold mb-4">ОШИБКА КОНФИГУРАЦИИ</h1>
                        <p className="text-gray-400 text-sm">Вы открыли файл напрямую или на GitHub без настройки Firebase. Для работы чата необходимо вставить Firebase Config в код.</p>
                    </div>
                </div>
            );

            if (loading) return <div className="h-screen bg-black flex items-center justify-center"><div className="w-10 h-10 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div></div>;

            if (!profile) return (
                <div className="h-screen flex items-center justify-center p-6 bg-[#020202]">
                    <div className="w-full max-w-sm fade-up">
                        <h1 className="text-5xl font-black italic syncopate text-center mb-8">auraM</h1>
                        <form onSubmit={handleAuth} className="bg-[#0a0a0a] p-8 rounded-[2rem] border border-white/5 space-y-4">
                            {authMode === 'register' && <input required placeholder="Имя" className="w-full bg-white/5 p-4 rounded-xl outline-none border border-white/5 focus:border-indigo-500" onChange={e => setForm({...form, name: e.target.value})} />}
                            <input required placeholder="ID" className="w-full bg-white/5 p-4 rounded-xl outline-none border border-white/5 focus:border-indigo-500" onChange={e => setForm({...form, username: e.target.value})} />
                            <input required type="password" placeholder="Пароль" className="w-full bg-white/5 p-4 rounded-xl outline-none border border-white/5 focus:border-indigo-500" onChange={e => setForm({...form, password: e.target.value})} />
                            <button className="w-full py-4 bg-indigo-600 rounded-xl font-bold hover:bg-indigo-500 transition-all uppercase tracking-widest">{authMode === 'login' ? 'Войти' : 'Создать'}</button>
                            <p onClick={() => setAuthMode(authMode === 'login' ? 'register' : 'login')} className="text-center text-[10px] text-indigo-400 cursor-pointer uppercase font-bold tracking-tighter">Сменить режим</p>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="fixed inset-0 flex bg-[#020202] text-white overflow-hidden">
                    <aside className={`absolute inset-0 z-30 w-full lg:relative lg:w-[360px] glass-panel flex flex-col transition-all ${activeChat ? '-translate-x-full lg:translate-x-0' : 'translate-x-0'}`}>
                        <header className="h-20 flex items-center px-6 space-x-4">
                            <button onClick={() => setSettingsOpen(true)} className="w-10 h-10 aura-card rounded-xl flex items-center justify-center"><i data-lucide="menu" className="w-5 h-5 text-indigo-500"></i></button>
                            <input placeholder="Поиск ID..." className="flex-1 bg-white/5 p-2 rounded-lg text-xs outline-none" onChange={e => setSearchQuery(e.target.value)} />
                        </header>
                        <div className="flex-1 overflow-y-auto px-4 space-y-2 custom-scrollbar">
                            <div onClick={() => setActiveChat({id:'global', name:'Global Hub', image:'https://ui-avatars.com/api/?name=GH&background=6366f1&color=fff'})} className="p-3 bg-indigo-600/10 rounded-xl cursor-pointer border border-indigo-500/20 flex items-center space-x-3">
                                <div className="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center"><i data-lucide="globe" className="w-5 h-5"></i></div>
                                <div><h4 className="text-sm font-bold">Global Hub</h4><p className="text-[8px] text-indigo-400 uppercase">Public Node</p></div>
                            </div>
                            {chats.map(c => (
                                <div key={c.id} onClick={() => setActiveChat(c)} className="p-3 hover:bg-white/5 rounded-xl cursor-pointer flex items-center space-x-3 transition-all">
                                    <img src={c.image} className="w-10 h-10 rounded-lg object-cover" />
                                    <h4 className="text-sm font-medium">{c.name}</h4>
                                </div>
                            ))}
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col relative">
                        {activeChat ? (
                            <>
                                <header className="h-20 flex items-center px-6 border-b border-white/5 space-x-4">
                                    <button onClick={() => setActiveChat(null)} className="lg:hidden p-2 text-indigo-500"><i data-lucide="chevron-left"></i></button>
                                    <img src={activeChat.image} className="w-10 h-10 rounded-lg" />
                                    <h2 className="font-bold">{activeChat.name}</h2>
                                </header>
                                <div className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
                                    {messages.map(m => (
                                        <div key={m.id} className={`flex ${m.senderId === profile.id ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`p-3 px-4 rounded-2xl max-w-[80%] ${m.senderId === profile.id ? 'msg-out' : 'aura-card'}`}>
                                                <p className="text-sm">{m.content}</p>
                                            </div>
                                        </div>
                                    ))}
                                    <div ref={messagesEndRef} />
                                </div>
                                <footer className="p-6">
                                    <div className="flex space-x-2">
                                        <input value={inputText} onChange={e => setInputText(e.target.value)} onKeyDown={e => e.key === 'Enter' && (async () => {
                                            if (!inputText.trim()) return;
                                            await window.FB.addDoc(window.FB.collection(db, 'artifacts', window.currentAppId, 'public', 'data', 'messages'), { chatId: activeChat.id, senderId: profile.id, content: inputText, timestamp: Date.now() });
                                            setInputText('');
                                        })()} placeholder="Сообщение..." className="flex-1 bg-white/5 p-4 rounded-xl outline-none border border-white/5 focus:border-indigo-500" />
                                        <button className="w-14 bg-indigo-600 rounded-xl flex items-center justify-center"><i data-lucide="send"></i></button>
                                    </div>
                                </footer>
                            </>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center opacity-20"><i data-lucide="sparkles" className="w-20 h-20 mb-4"></i><p className="syncopate italic">auraM Connected</p></div>
                        )}
                    </main>

                    {settingsOpen && (
                        <div className="fixed inset-0 z-[100] flex">
                            <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={() => setSettingsOpen(false)} />
                            <div className="relative w-64 h-full bg-[#080808] border-r border-white/5 p-6 fade-up">
                                <img src={profile.avatar} className="w-16 h-16 rounded-2xl mb-4" />
                                <h3 className="font-bold">{profile.name}</h3>
                                <p className="text-[10px] text-indigo-400 mb-8">@{profile.id}</p>
                                <button onClick={() => { localStorage.clear(); location.reload(); }} className="text-red-500 text-xs font-bold uppercase">Выйти</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

